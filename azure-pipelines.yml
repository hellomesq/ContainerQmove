trigger:
  branches:
    include:
      - main
      - master   # dispara CI/CD ao alterar a branch principal

pool:
  vmImage: 'ubuntu-latest'

variables:
  RG: 'rgqmove'
  ACR_NAME: 'acrqmove'
  APP_NAME: 'aci-qmove-api'
  DB_NAME: 'aci-qmove-db'
  LOCATION: 'eastus'
  IMAGE_NAME: 'qmoveapi:v1'

  # ‚ö†Ô∏è Essas vari√°veis devem ser protegidas no Azure DevOps (n√£o hardcode!)
  MYSQL_ROOT_PASSWORD: $(MYSQL_ROOT_PASSWORD)
  DB_DATABASE: $(DB_DATABASE)

steps:
  # ======================
  # 1Ô∏è‚É£ Checar c√≥digo
  # ======================
  - task: Checkout@1
    displayName: 'Obter c√≥digo do reposit√≥rio'

  # ======================
  # 2Ô∏è‚É£ Configurar Docker
  # ======================
  - task: DockerInstaller@0
    inputs:
      dockerVersion: 'latest'
    displayName: 'Instalar Docker'

  # ======================
  # 3Ô∏è‚É£ Etapa de Build (CI)
  # ======================
  - script: |
      echo "üöß Iniciando build e testes..."
      chmod +x ./build.sh
      ./build.sh
    displayName: 'Executar build da imagem e testes (CI)'

  # ======================
  # 4Ô∏è‚É£ Publicar artefato do build
  # ======================
  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)'
      ArtifactName: 'drop'
    displayName: 'Publicar artefatos de build'

  # ======================
  # 5Ô∏è‚É£ Etapa de Deploy (CD)
  # ======================
  - script: |
      echo "üöÄ Fazendo deploy da aplica√ß√£o..."
      chmod +x ./deploy.sh
      ./deploy.sh
    displayName: 'Executar deploy autom√°tico (CD)'
